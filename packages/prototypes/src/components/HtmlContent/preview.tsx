import { defineComponent } from 'vue-demi'
import { composeExport } from '@lj-portal/vant/esm/__builtins__'
import {
  GlobalRegistry,
  createBehavior,
  createResource,
} from '@designable/core'
import { useTreeNode } from '@formily/antdv-designable'
import CKEditor from '@ckeditor/ckeditor5-vue2'
import BalloonEditor from '@ckeditor/ckeditor5-build-balloon'
import { AllSchemas } from '../../schemas'
import { AllLocales } from '../../locales'
import { createFieldSchema } from '../Field'
import './styles.less'

export const HtmlContent = composeExport(
  defineComponent({
    props: { content: {} },
    setup(props) {
      const nodeRef = useTreeNode()

      return () => {
        const node = nodeRef.value
        const locale = GlobalRegistry.getDesignerLanguage()

        const editProps = {
          value: props.content,
          config: {
            toolbar: {
              items: [
                'bold',
                'italic',
                'strikethrough',
                'underline',
                'highlight',
                '|',
                'fontSize',
                'fontColor',
                'fontBackgroundColor',
                '|',
                'bulletedList',
                'numberedList',
                '|',
                'undo',
                'redo',
              ],
            },
            fontSize: {
              options: [9, 10, 12, 14, 18, 22, 28],
            },
            language: { 'en-US': 'en', 'zh-CN': 'zh-cn' }[locale] || 'en-US',
          },
          editor: BalloonEditor,
        }

        return (
          <CKEditor.component
            class="dn-html-content"
            props={editProps}
            onInput={(value: string) =>
              node.setProps({
                'x-component-props': {
                  content: value,
                },
              })
            }
          />
        )
      }
    },
  }),
  {
    Behavior: createBehavior({
      name: 'HtmlContent',
      extends: ['Field'],
      selector: (node) => node.props['x-component'] === 'HtmlContent',
      designerProps: {
        propsSchema: createFieldSchema(AllSchemas.HtmlContent),
      },
      designerLocales: AllLocales.HtmlContent,
    }),
    Resource: createResource({
      icon: (
        <g
          id="页面-1"
          stroke="none"
          stroke-width="1"
          fill="none"
          fill-rule="evenodd"
        >
          <g id="HTML" fill-rule="nonzero">
            <rect
              id="矩形"
              fill="#FFFFFF"
              opacity="0"
              x="0"
              y="0"
              width="1024"
              height="1024"
            ></rect>
            <polygon
              id="路径"
              fill="#D8D8D8"
              points="690 290 690 540 20 540 20 290"
            ></polygon>
            <g
              transform="translate(99.270000, 351.480000)"
              fill="#1890FF"
              id="路径"
            >
              <path d="M0,9.81 L0,118.71 C4.21621671e-15,124.127913 4.3920866,128.52 9.81,128.52 C15.2279134,128.52 19.62,124.127913 19.62,118.71 L19.62,70.92 L19.62,70.92 L86.94,70.92 L86.94,118.71 C86.94,124.127913 91.3320866,128.52 96.75,128.52 C102.167913,128.52 106.56,124.127913 106.56,118.71 L106.56,9.81 C106.56,4.3920866 102.167913,-9.95254545e-16 96.75,0 C91.3320866,9.95254545e-16 86.94,4.3920866 86.94,9.81 L86.94,54.18 L86.94,54.18 L19.62,54.18 L19.62,9.81 C19.62,4.3920866 15.2279134,-9.95254545e-16 9.81,0 C4.3920866,9.95254545e-16 1.11285381e-15,4.3920866 0,9.81 Z"></path>
              <path d="M129.86,8.37 C129.86,12.9926234 133.607377,16.74 138.23,16.74 L172.88,16.74 L172.88,16.74 L172.88,118.8 C172.88,124.168208 177.231792,128.52 182.6,128.52 C187.968208,128.52 192.32,124.168208 192.32,118.8 L192.32,16.74 L192.32,16.74 L226.79,16.74 C231.412623,16.74 235.16,12.9926234 235.16,8.37 C235.16,3.74737664 231.412623,-5.0722314e-15 226.79,0 L138.23,0 C133.607377,8.49162135e-16 129.86,3.74737664 129.86,8.37 Z"></path>
              <path d="M258.64,11.61 L258.64,118.71 C258.64,124.127913 263.032087,128.52 268.45,128.52 C273.867913,128.52 278.26,124.127913 278.26,118.71 L278.26,36.72 L278.26,36.72 L278.98,36.72 L315.061925,120.7464 C317.087254,125.46292 321.727017,128.52 326.86,128.52 C331.992983,128.52 336.632746,125.46292 338.658075,120.7464 L374.74,36.72 L374.74,36.72 L375.46,36.72 L375.46,118.71 C375.46,124.127913 379.852087,128.52 385.27,128.52 C390.687913,128.52 395.08,124.127913 395.08,118.71 L395.08,11.61 C395.08,5.19797405 389.882026,1.02121761e-14 383.47,0 C376.421379,1.29481072e-15 370.045541,4.18496276 367.241687,10.6519148 L327.327403,102.712281 C327.262197,102.862675 327.113921,102.96 326.95,102.96 C326.786036,102.96 326.637677,102.862777 326.572233,102.712439 L286.493973,10.6451112 C283.679873,4.18059208 277.300473,-1.29515084e-15 270.25,0 C263.837974,1.17787006e-15 258.64,5.19797405 258.64,11.61 Z"></path>
              <path d="M428.28,9.72 L428.28,108.52 C428.28,119.565695 437.234305,128.52 448.28,128.52 L510.09,128.52 C514.712623,128.52 518.46,124.772623 518.46,120.15 C518.46,115.527377 514.712623,111.78 510.09,111.78 L467.72,111.78 C456.674305,111.78 447.72,102.825695 447.72,91.78 L447.72,9.72 C447.72,4.35179223 443.368208,-9.86123769e-16 438,0 C432.631792,9.86123769e-16 428.28,4.35179223 428.28,9.72 Z"></path>
            </g>
            <path
              d="M944,0 C988.18278,0 1024,35.81722 1024,80 L1024,944 C1024,988.18278 988.18278,1024 944,1024 L80,1024 C35.81722,1024 0,988.18278 0,944 L0,80 C0,35.81722 35.81722,0 80,0 L944,0 Z M744,20 L80,20 C47.1942859,20 20.5378857,46.328343 20,79.0077903 L20,80 L20,944 C20,976.805714 46.328343,1003.46211 79.0077903,1004 L80,1004 L944,1004 C976.805714,1004 1003.46211,977.671657 1004,944.99221 L1004,944 L1004,280 C1004,247.194286 777.671657,20.5378857 744.99221,20 L744,20 Z"
              id="形状"
              fill="#999999"
            ></path>
            <rect
              id="矩形"
              fill="#999999"
              transform="translate(355.000000, 290.000000) scale(-1, 1) rotate(-90.000000) translate(-355.000000, -290.000000) "
              x="345"
              y="-45"
              width="20"
              height="670"
              rx="10"
            ></rect>
            <rect
              id="矩形备份-8"
              fill="#999999"
              transform="translate(355.000000, 540.000000) scale(-1, 1) rotate(-90.000000) translate(-355.000000, -540.000000) "
              x="345"
              y="205"
              width="20"
              height="670"
              rx="10"
            ></rect>
            <path
              d="M746.710678,731.289322 C742.805435,727.384079 736.473785,727.384079 732.568542,731.289322 L605.289322,858.568542 C601.384079,862.473785 601.384079,868.805435 605.289322,872.710678 C609.194565,876.615921 615.526215,876.615921 619.431458,872.710678 L746.710678,745.431458 C750.615921,741.526215 750.615921,735.194565 746.710678,731.289322 Z M459.645629,802.784251 C459.680486,805.296746 460.656474,807.79861 462.573593,809.715729 L533.284271,880.426407 C537.189514,884.33165 543.521164,884.33165 547.426407,880.426407 C551.33165,876.521164 551.33165,870.189514 547.426407,866.284271 L483.643339,802.499661 L547.426407,738.715729 C551.260645,734.88149 551.330359,728.708276 547.635547,724.788984 L547.426407,724.573593 C543.521164,720.66835 537.189514,720.66835 533.284271,724.573593 L462.573593,795.284271 C460.656474,797.20139 459.680486,799.703254 459.645629,802.215749 Z M893.354371,802.784251 C893.319514,805.296746 892.343526,807.79861 890.426407,809.715729 L819.715729,880.426407 C815.810486,884.33165 809.478836,884.33165 805.573593,880.426407 C801.66835,876.521164 801.66835,870.189514 805.573593,866.284271 L869.356661,802.499661 L805.573593,738.715729 C801.739355,734.88149 801.669641,728.708276 805.364453,724.788984 L805.573593,724.573593 C809.478836,720.66835 815.810486,720.66835 819.715729,724.573593 L890.426407,795.284271 C892.343526,797.20139 893.319514,799.703254 893.354371,802.215749 Z"
              id="形状结合"
              fill="#999999"
            ></path>
          </g>
        </g>
      ),
      elements: [
        {
          componentName: 'Field',
          props: {
            type: 'string',
            'x-component': 'HtmlContent',
            'x-component-props': {
              content: '<p><strong>HTML</strong> content</p>',
            },
          },
        },
      ],
    }),
  }
)
